<!--Menu-->

<!--/Menu-->
<!--Formulario para cambiar estado de accion-->
<%= render 'form_change', accion: @accion %>
<!--/Formulario para cambiar estado de accion-->
<!--Menu Tabs-->

<!--/Menu Tabs-->
<!--Alerta de cierre o solicitud de cierre-->

<%if @accion.tipo == "Accion"%>
 <%= link_to "Volver a Acciones" ,report_accions_path(@report), class: "linka" %>
<%elsif @accion.tipo == "Correccion"%>
 <%= link_to "Volver a Correcciones" ,report_correcciones_path(@report), class: "linka" %>
<%else%>

 <%= link_to "Volver a Actividades" ,report_actividades_path(@report), class: "linka" %>

 <%end%>

<%if @accion.estado != "Cerrada"   &&  @accion.s_cierre%>
<div class="alert alert-success text-center" > 
   <i class="fa fa-thumbs-o-up" style = "font-size:30px;margin-right: 15px;" aria-hidden="true"></i>¡EL RESPONSABLE DE LA EJECUCION SOLICITO EL CIERRE DE LA ACCION!
</div>
<%end%>
<% if @accion.estado == "Cerrada"  %>
<% if @accion.cumplio %>
<div class="alert alert-success text-center" style="display:none"> 
   <i class="fa fa-thumbs-o-up" style = "font-size:30px;margin-right: 15px;" aria-hidden="true"></i>¡LA <%=@accion.tipo.upcase%> SE CERRO Y SE CUMPLIO CON LA FECHA ! 
</div>
<%else%>
<div class="alert alert-danger text-center" > 
   <i class="fa fa-thumbs-o-down" style = "font-size:30px;margin-right: 15px;" aria-hidden="true"></i>¡LA <%=@accion.tipo.upcase%> SE CERRO CON EXITO PERO NO SE CUMPLIO CON LA FECHA! <button style = "margin-left:50px" type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#accion_change_state">¿Cumplio?</button>
</div>
<%end%>
<%end%>
<!--/Alerta de cierre o solicitud de cierre-->
<div class="modal fade" id="myModal" role="dialog">
   <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title modalp1">Informacion del Reporte</h4>
         </div>
         <div class="modal-body">
            <table class = "reporte">
               <tr>
                  <th>Codigo</th>
                  <td><%= @report.codigo %></td>
                  <th>Fuente</th>
                  <td><%= @report.source.name %></td>
               </tr>
               <tr>
                  <th>Descripcion</th>
                  <td colspan="3"><%= @report.description%></td>
               </tr>
            </table>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
         </div>
      </div>
   </div>
</div>
<!--Muestra Informacion y seguimiento-->

<div class = "row" style="margin-top:20px">
<!--Informacion-->
   <div class="col-md-12 wihtout-padding" >
      <h4 class = "linka htitle"><%=@accion.tipo %> (<%=@accion.codigo %>): <span style="color:gray"><%=@accion.name%></span> <span style="float: right"><%if @accion.estado == "Abierta" %>
             <i class="fa fa-unlock" style="font-size: 30px"></i>
             <%else%>
               <i class="fa fa-lock" style="font-size: 30px"></i>
             <%end%>  
            </div></span>
       
      </h4>
      <div class="conteinter reporte cnt">
         
         <div class="row rtr">
            <%if @accion.causa_efectos.exists?%>
            <div class="col-md-12 rtd"><strong>Causas: </strong><%= @accion.causa_efectos.pluck(:name).join(", ") %></div>
            <%end%></div>
            <div class="row rtr">
            <div class="col-md-3 rtd"><strong>Fecha de Creacion:<br></strong> <%= get_date(@accion.created_at) %></div>
   
            <% employed1 = Employed.find(@accion.employed_id)%>
            <div class="col-md-3 rtd"><strong>Reporta: <br></strong><%= employed1.first_name %> <%= employed1.first_last_name %></div>
            
    
            <div class="col-md-3 rtd"><strong>Costo Presupuestado:<br> </strong><%= number_to_currency(@accion.costo_presupuestado) %></div>
            <div class="col-md-3 rtd"><strong>Costo Real: </strong><br><%= number_to_currency(@accion.costo) %></div>
         </div>
         <hr>
         <div class="row rtr">
            <div class="col-md-6 rtd"><strong>Responsable:</strong> <% employed = Employed.find(@accion.employed_id)%>
               <%= employed.first_name %> <%= employed.first_last_name %><br>
               <strong>Responsable de Cierre:</strong> <% employed = Employed.find(@accion.cierra_id)%>
               <%= employed.first_name %> <%= employed.first_last_name %>
               <br>
               <strong>Otros Interesados: </strong><% 
                  cm = 0 
                  @accion.employeds.each do |resp|
                    %><%= "," if cm != 0 %> 
               <button type="button" class="btn numerb" data-container="body" data-toggle="popover" data-placement="top" data-content="<p style='text-align:center;margin:0px;padding:0px;'><img src='<%= resp.avatare_url(:thumb) %>'></p><br><strong>Cargo: </strong><%=resp.cargo.name %><br> <strong>Email:</strong> <%= resp.email%><br><strong>Cedula:</strong> <%= resp.document %>"><%= resp.first_name %> <%= resp.first_last_name %></button>
               <%  cm = cm + 1 %> 
               <%end%>
            </div>
            <div class="col-md-6 rtd" style="color:white;background:<%=get_color(@accion.contador_seg)%>"> Fecha de Entrega <%= get_date(@accion.f_compromiso)%> &nbsp;&nbsp;&nbsp; <%= @accion.contador_seg < 0 ?  "Vencido" :  "Faltan"%> <%=@accion.contador_seg.abs%> días<strong style = "margin-left:10px;"><%= "Fecha de seguimiento:" if @accion.f_seguimiento != 0%> </strong> <%= get_date(@accion.fp_seguimiento) if @accion.fp_seguimiento && @accion.f_seguimiento != 0 %><br><strong  style = "">Frecuencia de Seguimiento: </strong><%=f_seguimiento(@accion.f_seguimiento) %></div>
              <div class="col-md-12">
              <a class="" role="button" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
+ Mas Informacion
</a>
       </div>
         </div>
     
         

    <div class="row rtr">

<div class="collapse" id="collapseExample">
  <div class="well">
  <div class="row">
    

           <div class="col-md-12 rtd text-left">
               <div class="descnum"><strong>Descripcion:</strong> <%= @accion.descripcion%></div>
            </div>
            <div class="col-md-12 rtd text-left">
               <strong>Posible Evidencia:</strong> <%= @accion.evidencia%>
            </div>
            <!--<div class="col-md-12 rtd"><strong>Descripcion</strong></div>-->
          
         </div>  </div>
  </div>
</div>
         
      </div>
   </div>
   <!--/Informacion-->
   <!--Seguimiento-->
   <br>
   <ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#home">SEGUIMIENTOS (<%= @seguimientos.count %>)</a></li>
  <li><a data-toggle="tab" href="#menu1">TAREAS ABIERTAS <span class="tasks_abierta">(<%= @tasks.count %>)</span></a></li>
  <li><a data-toggle="tab" href="#menu2">TAREAS CERRADAS <span class="tasks_cerrada"> (<%= @tasksc.count %>)</span></a></li>
</ul>
<br>
<div class="tab-content">
  <div id="home" class="tab-pane fade in active">
   <div class="col-md-12 wihtout-padding" style="max-height: 350px;height: 350px;overflow: auto">
      <div class="conteinter htitle" style = "padding:0px">
         <div class="row rtr">
            <div class="col-md-2 rtd"></div>
            <div class="col-md-8 rtd">
               <h3 class="htitle linka text-center">Seguimientos (<%=@accion.aseguimientos.count %>)</h3>
            </div>
            <div class="col-md-2 rtd">
               <% if @seguimientos.count > 0 %>
               <%= link_to 'Nuevo Seguimiento', new_report_accion_aseguimiento_path(@report,@accion), remote: true,:class => 'btn btn-primary pull-right' %><%end%>
            </div>
         </div>
      </div>
      <% if @seguimientos.count > 0 %>
            <% @seguimientos.each do |seg| %>
               <% if seg.cierra %>
                  <div class="conteinter reporte cnt">
                          <div class="row rtr">
                                  <div class="col-md-4 rtd linka cierra">Seguimiento que cierra la Accion</div>
                                  <div class="col-md-2 rtd"><strong>Creacion:</strong> <%= get_date(seg.created_at) %></div>
                                  <div class="col-md-2 rtd">
                                    <strong>Responsable:</strong> <%  idemp = User.find(seg.user_id).email
                                        employed = Employed.where(email: idemp).take
                                        %>
                                    <td  class = "imaacc">
                                        <%= employed.first_name %> <%= employed.first_last_name %>
                                  </div>
                                  <div class="col-md-2 rtd"><strong>Evidencia: </strong><%= link_to "Ver Evidencia", seg.evidencia_url if seg.evidencia_url %><%=image_tag get_extension(seg.evidencia.file.extension) if seg.evidencia_url%></div>
                                  <div class="col-md-2 rtd text-right"><%= link_to  edit_report_accion_aseguimiento_path(@report,@accion,seg),remote: true, :class => "opciones" do %>
                                  <i class="fa fa-pencil" aria-hidden="true"></i>
                                  <% end %>
                                  <%= link_to  report_accion_aseguimiento_path(@report,@accion,seg),  method: :delete, data: { confirm: 'Are you sure?' }, :class => "opciones" do %>
                                  <i class="fa fa-trash" aria-hidden="true"></i>
                                  <% end %>
                                  </div>
                          </div>
                          <hr>
                          <div class="row rtr">
                              <div class="col-md-12 rtd text-left"><strong>Descripcion: </strong> <%= seg.descripcion %></div>
                          </div>
                          <hr>
                          <div class="row rtr">
                                <div class="col-md-3 rtd text-left"><strong>¿Eficaz?: </strong><% if  seg.eficaz%>
                                <i class="fa fa-thumbs-o-up" style = "font-size:30px;margin-right: 15px;" aria-hidden="true"></i>
                                <%else %>
                                <i class="fa fa-thumbs-o-down" style = "font-size:30px;margin-right: 15px;" aria-hidden="true"></i>
                                <%end %></div>
                                  <div class="col-md-6 rtd text-left" style = "margin-top: 13px;"><strong>Conclusión: </strong> <%= seg.conclucion %></div>
                                  <div class="col-md-3 rtd text-left" style = "margin-top: 13px;"><strong>Costo: </strong> <%= number_to_currency(seg.costo)%>
                                  </div>
                          </div>
                  </div>
                  <%else%>
                      <div class="conteinter reporte cnt ">
                        <div class="row rtr">
                            <div class="col-md-1">
                            <%  idemp = User.find(seg.user_id).email
                              employed1 = Employed.where(admin_user: current_user.admin_user, email: idemp).first
                              %>
                            <img class ="seg-img" src='<%= employed1.avatare_url(:thumb) %>'>
                            </div>
                            <div class="col-md-11">
                            <div class="col-md-4 rtd wihtout-padding-bot">
                            <%= employed1.first_name %> <%= employed1.first_last_name %>
                            </div>
                            <div class="col-md-3 rtd wihtout-padding-bot"><strong><i class="fa fa-calendar" aria-hidden="true"></i></strong> <%=  get_date(seg.created_at)  %></div>
                            <div class="col-md-3 rtd "><strong><i class="fa fa-paperclip" aria-hidden="true"></i> </strong><%= (link_to "Evidencia",seg.evidencia_url, class:"linka") if seg.evidencia_url %></div>
                            <div class="col-md-2 rtd text-right wihtout-padding-bot"><%= link_to  edit_report_accion_aseguimiento_path(@report,@accion,seg),remote: true, :class => "opciones" do %>
                            <i class="fa fa-pencil" aria-hidden="true"></i>
                            <% end %>
                            <%= link_to  report_accion_aseguimiento_path(@report,@accion,seg),  method: :delete ,data: { confirm: 'Are you sure?' }, :class => "opciones" do %>
                            <i class="fa fa-trash" aria-hidden="true"></i>
                            <% end %>
                            </div>
                            <div class="col-md-12 wihtout-padding-top text-left"><%= seg.descripcion %></div>
                            </div>
                        </div>
                      </div>
                  <% end %>
          <% end %>
      <% else %>
            <div class="jumbotron jumbacc">
            <h3 class="display-3 text-gray">No se ha creado ningun seguimiento</h3>
            <hr class="my-4">
            <br>
            <br>
            <%= link_to 'Nuevo Seguimiento', new_report_accion_aseguimiento_path(@report,@accion), remote:true,:class => 'btn btn-primary btn-lg'  %>
            </p>
            </div>
      <% end %>
   </div>
  </div>
  <div id="menu1" class="tab-pane fade">
    <div class="col-md-12 wihtout-padding">
  
             
              <div class="task_abiertasa">
                     <%= render :partial => "task_abiertas"%> 
                 </div>


        </div>
  </div>
  <div id="menu2" class="tab-pane fade">
    <div class="col-md-12 wihtout-padding">
          <div class="task_cerradasa">
                     <%= render :partial => "task_cerradas"%> 
                 </div>
</div>
  </div>
</div>


  
   <!--Seguimiento-->
</div>

<!--/Muestra Informacion y seguimiento-->
<br>
<hr class="hr">
<br>
<!--Tareas-->
<div class="row">
<!--Tareas Abiertas-->
   
        <!--/Tareas Abiertas-->
        <!--Tareas Cerradas-->
       

<!--/Tareas Cerradas-->

</div>
<!--/Tareas-->
<script>
   $(function () {
   $('[data-toggle="popover"]').popover({
     trigger: 'hover',
     html: true
     
   
   })
   })
   
</script>
<style>
.cierra
{
font-size: 16px;
font-weight: bold;
}
.imaacc img
{
border-radius: 40px;
}
.cnt
{
border: 1px solid #c3c3c3;
margin-bottom: 10px;
}
.rtr
{
}
.rtd
{
padding: 10px;
}
.titulo
{
background:#f2f2f2;
}
hr
{
margin-top: 0px;
margin-bottom: 0px;
}
.well
{
    padding-bottom: 5px !important;
    background-color: white !important;
     border: none !important;
     border-radius: 0px !important; 
 
}
</style>